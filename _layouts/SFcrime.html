<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/css/SFcrime.css" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDS2PDfYwmOn1qzqc6V7kmisoUFLG6jLzA">
    </script>

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=false">
    </script>

    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerwithlabel/1.1.9/src/markerwithlabel_packed.js"></script>

    <script type="text/javascript">
      var vehicle_theft_data;
      var vehicle_theft_district_data;
      var lat;
      var heatmap = []; //array of heatmaps per district
      var heatmapData = []; //2 dimensional array heat map pts by district
      var district_markers = [];
      function addHeatMapData(){

        $.each( vehicle_theft_data.X, function( i, lng ) {
            //var district = vehicle_theft_data.PdDistrict[i];
            //heatmapData[district] = heatmapData[district] ? heatmapData[district] : [];
            heatmapData[i] = new google.maps.LatLng(lat[i], lng);
        });

        //$.each( heatmapData, function(i, data){
          heatmap = new google.maps.visualization.HeatmapLayer({
            data: heatmapData
          });
          heatmap.setMap(null);
          //heatmap[i].setMap(null);
        //});
        
      };

      function toggleHeatmap() {
        //$.each(heatmap, function(i,district){
         // heatmap.setMap(heatmap.getMap() ? null : map);

          if(heatmap.getMap()){
            heatmap.setMap(null);
            $.each(district_markers,function(i,marker){
              marker.setVisible(true);
            });
          }else{
            $.each(district_markers,function(i,marker){
              marker.setVisible(false);
            });
            heatmap.setMap(map);
          }
        //}); 
      }

     function addDistrictData(){
      $.each( vehicle_theft_district_data.PdDistrict, function( i, district){
          var loc = new google.maps.LatLng(vehicle_theft_district_data.Y[i], vehicle_theft_district_data.X[i]);
          var marker = new MarkerWithLabel({
            position: loc,
            map: map,
            title: district,
            animation: google.maps.Animation.DROP,
            icon: getCircle(vehicle_theft_district_data.Total[i]),
            labelContent: "<div>"+district+"<div class='district_total'>"+vehicle_theft_district_data.Total[i]+"</div></div>",
            labelAnchor: new google.maps.Point(40, 10),
            labelClass: "labels", // the CSS class for the label
            labelStyle: {opacity: 0.75},
            labelInBackground: false
          });

          district_markers[i] = marker;

          google.maps.event.addListener(marker, 'mouseover', function() {
              marker.opacity = 1;
          });

          google.maps.event.addListener(marker, 'mouseout', function() {
              marker.opacity = 0.75;
          });
        }
      );
     };

     function getCircle(magnitude) {
        return {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: 'red',
          fillOpacity: .4,
          scale: 0.25*magnitude,
          strokeColor: 'white',
          strokeWeight: .5
        };
      };
     
    
      function initialize() {


        var sanFrancisco = new google.maps.LatLng(37.774546, -122.433523);
        var mapOptions = {
          center: sanFrancisco,
          zoom: 12,
          minZoom: 12,
          streetViewControl: false,
          mapTypeId: google.maps.MapTypeId.ROAD
        };

        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(
        document.getElementById('legend'));
        map.controls[google.maps.ControlPosition.LEFT_TOP].push(
        document.getElementById('zoom_level'));
        map.setOptions(highLevelStyles);

          // bounds of the desired area
      var allowedBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(37.590059187414685, -122.63448208007815),
          new google.maps.LatLng(37.80174049420249, -122.3091720214844)
          
      );
      var lastValidCenter = map.getCenter();

      google.maps.event.addListener(map, 'center_changed', function() {
          if (allowedBounds.contains(map.getCenter())) {
            // still within valid bounds, so save the last valid position
            lastValidCenter = map.getCenter();
          } else{
            // not valid anymore => return to last valid position
            alert("not in bounds");
            map.panTo(lastValidCenter);
          }
      });

        google.maps.event.addListener(map, 'zoom_changed', function () {
          var zoomLevel = map.getZoom();
          document.getElementById('zoom_level').innerHTML = 'Zoom Level: ' + zoomLevel;
          
          if(heatmap.getMap() || zoomLevel < 12 || zoomLevel > 13){
            $.each(district_markers,function(i,marker){
              marker.setVisible(false);
            });
          }else{
            $.each(district_markers,function(i,marker){
              marker.setVisible(true);
            });
          }

          if (zoomLevel > 10) {
              map.setOptions(highLevelStyles);
          } else {
              map.setOptions(lowLevelStyles);
          }
        });
      }

      var highLevelStyles = {
        styles: [{
            'featureType': 'all',
                'elementType': 'labels',
                'stylers': [{
                'visibility': 'on'
            }]
        }]
    };

    var lowLevelStyles = {
        styles: [{
            'featureType': 'all',
                'elementType': 'labels',
                'stylers': [{
                'visibility': 'off'
            }]
        }, {
            'featureType': 'road',
                'elementType': 'labels.icon',
                'stylers': [{
                'visibility': 'off'
            }]
        }, {
            'stylers': [{
                'hue': '#00aaff'
            }, {
                'saturation': -50
            }, {
                'gamma': 1.15
            }, {
                'lightness': 12
            }]
        }, {
            'featureType': 'road',
                'elementType': 'labels.text.fill',
                'stylers': [{
                'visibility': 'on'
            }, {
                'lightness': 24
            }]
        }, {
            'featureType': 'road',
                'elementType': 'geometry',
                'stylers': [{
                'lightness': 85
            }]
        }]
    };

      google.maps.event.addDomListener(window, 'load', initialize);


           $.when(
        // Get all the data points for vehicle thefts
        $.getJSON('/assets/vehicle.theft.json', function(json) {
          vehicle_theft_data =  json;
          lat = vehicle_theft_data.Y;
        }),

        // Get the PdDistrict mean locations and numbers
        $.getJSON("/assets/vehicle.theft.location.json", function(json) {
          vehicle_theft_district_data = json;
        })


      ).then(function() {//consider adding on fail or on progress function handling

        // All is ready now
        addHeatMapData();
        addDistrictData();

      });

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="legend">
      SF Vehicle Thefts Visualization August - October 2014
      <button onclick="toggleHeatmap()">Toggle Heatmap</button>
    </div>
    <div id="zoom_level"></div>
  </body>
</html>

